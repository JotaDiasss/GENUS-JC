{% extends 'layout.html' %}
{% load static %}

{% block title %}Filtrar Notícias{% endblock %}

{% block extra_css %}
    {% endblock %}

{% block content %}
<main class="main-content" style="max-width: 800px; margin: 40px auto; padding: 0 15px;">
    <section class="content-section">
        <div class="section-header">
            <h1 class="titulo-principal">{{ titulo_pagina }}</h1>
        </div>

        <form method="GET" action="{% url 'jornal:filtrar_por_genero' %}" id="genre-filter-form" class="filter-form-container">
            
            <div id="filter-error-message" style="color: red; font-weight: bold; margin-bottom: 15px; text-align: center;">
                {% if search_error %}
                    <p>{{ search_error }}</p>
                {% endif %}
            </div>

            <p class="filter-instructions">Selecione até 2 gêneros para filtrar.</p>
            
            <div class="genre-container-config">
                {% for genre in all_genres %}
                    <div class="genre-item-config">
                        <input type="checkbox" name="genres" value="{{ genre.nome }}" id="genre-{{ genre.id }}"
                               class="genre-checkbox"
                               {% if genre.nome in selected_genres_names %}checked{% endif %}>
                        <label for="genre-{{ genre.id }}">{{ genre.nome }}</label>
                    </div>
                {% endfor %}
            </div>

            <div class="form-actions">
                <button type="submit" class="filter-button">Filtrar Notícias</button>
                <a href="{% url 'jornal:filtrar_por_genero' %}" class="reset-button">Limpar Filtro</a>
            </div>
        </form>
    </section>

    {% if noticias %}
    <section class="noticias-principais" style="margin-top: 40px;">
        <div class="lista-noticias">
            {% for noticia in noticias %}
                <article class="noticia-card">
                    <h2 class="noticia-card-titulo">
                        <a href="{% url 'jornal:pagina_noticias' noticia.slug %}">{{ noticia.titulo }}</a>
                    </h2>
                    <p class="noticia-card-resumo">{{ noticia.resumo }}</p>
                    <a href="{% url 'jornal:pagina_noticias' noticia.slug %}" class="noticia-card-link">Leia mais</a>
                </article>
            {% endfor %}
        </div>
    </section>
    {% elif form_submitted and not search_error %}
        <p style="text-align: center; font-size: 1.1em; margin-top: 20px;">
            Nenhuma notícia encontrada para os gêneros selecionados.
        </p>
    {% endif %}

</main>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[name="genres"]');
    const errorMessageContainer = document.getElementById('filter-error-message');
    const form = document.getElementById('genre-filter-form');
    const maxChecked = 2;

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (errorMessageContainer.textContent.includes('Você só pode selecionar até 2 gêneros.')) {
                 errorMessageContainer.innerHTML = '';
            }

            let checkedCount = document.querySelectorAll('input[name="genres"]:checked').length;
            
            if (checkedCount > maxChecked) {
                checkbox.checked = false;
                errorMessageContainer.innerHTML = '<p>Você só pode selecionar até 2 gêneros.</p>';
            }
        });
    });

    form.addEventListener('submit', (event) => {
        let checkedCount = document.querySelectorAll('input[name="genres"]:checked').length;
        if (checkedCount === 0) {
            event.preventDefault(); // Impede o envio
            errorMessageContainer.innerHTML = '<p>Por favor, selecione pelo menos 1 gênero para filtrar.</p>';
        }
    });
});
</script>
{% endblock %}